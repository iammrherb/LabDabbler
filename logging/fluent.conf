# Fluentd Configuration for LabDabbler Production Logging

# Source for backend application logs
<source>
  @type tail
  @id backend_logs
  path /var/log/labdabbler/*.log
  pos_file /var/log/fluentd/backend.log.pos
  tag labdabbler.backend
  format json
  read_from_head true
  refresh_interval 5
</source>

# Source for nginx access logs
<source>
  @type tail
  @id nginx_access_logs
  path /var/log/nginx/access.log
  pos_file /var/log/fluentd/nginx_access.log.pos
  tag labdabbler.nginx.access
  format nginx
  read_from_head true
  refresh_interval 5
</source>

# Source for nginx error logs
<source>
  @type tail
  @id nginx_error_logs
  path /var/log/nginx/error.log
  pos_file /var/log/fluentd/nginx_error.log.pos
  tag labdabbler.nginx.error
  format multiline
  format_firstline /^\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}/
  format1 /^(?<time>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?<log_level>\w+)\] (?<pid>\d+).(?<tid>\d+): (?<message>.*)/
  read_from_head true
  refresh_interval 5
</source>

# Add environment and service tags
<filter labdabbler.**>
  @type record_transformer
  enable_ruby true
  <record>
    environment production
    service labdabbler
    timestamp ${time}
  </record>
</filter>

# Parse backend JSON logs
<filter labdabbler.backend>
  @type parser
  key_name message
  reserve_data true
  <parse>
    @type json
  </parse>
</filter>

# Output to stdout for debugging (remove in production)
<match labdabbler.**>
  @type stdout
  @id stdout_output
</match>

# Output to file for local storage
<match labdabbler.**>
  @type file
  @id file_output
  path /var/log/fluentd/labdabbler
  append true
  time_slice_format %Y%m%d
  time_slice_wait 10m
  time_format %Y%m%dT%H%M%S%z
  compress gzip
  <format>
    @type json
  </format>
</match>